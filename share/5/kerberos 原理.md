# kerberos 原理

## kerberos 基本概念

#### **1. Key Distribution Center, or KDC**

在启用Kerberos的环境中进行身份验证的受信任源。

#### **2. Kerberos KDC Server**

作为密钥分发中心（KDC）的计算机或服务器。

#### **3. Kerberos Client**

集群中针对KDC进行身份验证的任何计算机。

#### **4. KDC Admin Account**

Ambari用于在KDC中创建主体并生成密钥表的管理帐户。

#### **5. Principal**

Kerberos principal（又称为**主体**）用于在kerberos加密系统中标记一个唯一的身份。**主体**可以是**用户**（如`joe`）或**服务**（如`namenode`或`hive`）。

joe/admin@EXAMPLE.COM

- `joe`是主名称。主名称可以是此处所示的用户名或namenode等服务。

- `admin`是实例。对于用户主体，实例是可选的；但对于服务主体，实例则是必需的。例如，如果用户 `joe` 有时充当系统管理员，则他可以使用 `joe/admin` 将其自身与平时的用户身份区分开来。同样，如果 `joe` 在两台不同的主机上拥有帐户，则他可以使用两个具有不同实例的主体名称，例如 `joe/node1.example.com` 和 `joe/node2.example.com`。请注意，Kerberos 服务会将 `joe` 和 `joe/admin` 视为两个完全不同的主体。 对于服务主体，实例是全限定主机名。例如，`node1.example.com`就是这种实例。

- `EXAMPLE.COM`是Kerberos领域。

  ​

#### **6. realms name**

包含KDC和许多客户端的Kerberos网络，类似于域，俗称为领域。

#### **7. keytab**

`keytab`是包含`principals`和加密`principal key`的文件。

`keytab`文件对于每个`host`是唯一的，因为`key`中包含`hostname`。keytab文件用于不需要人工交互和保存纯文本密码，实现到`kerberos上`验证一个主机上的`principal`。

因为服务器上可以访问`keytab`文件即可以以`principal`的身份通过`kerberos`的认证，所以，`keytab`文件应该**被妥善保存，应该只有少数的用户可以访问。**

#### **8. ticket（票证）**

ticket是一种信息包，用于将用户身份安全地传递到服务器或服务。一个票证仅对一台客户机以及某台特定服务器上的一项特殊服务有效。票证包含以下内容：

- 服务的主体名称
- 用户的主体名称
- 用户主机的 IP 地址
- 时间标记
- 定义票证生命周期的值
- 会话密钥的副本

所有此类数据都使用服务器的服务密钥进行加密。 请注意，KDC 可颁发嵌入在以下介绍的凭证中。 颁发票证之后，可重用票证直到其到期为止。

#### **9. credential（凭证）**

是一种信息包，其中包含票证和匹配的会话密钥。凭证使用发出请求的主体的密钥进行加密。通常，KDC 会生成凭证以响应客户机的票证请求。

#### **10. authenticator（校验器）**

是服务器用于验证客户机用户主体的信息。 验证者包含用户的主体名称、时间标记和其他数据。 与票证不同，验证者只能使用一次，通常在请求访问服务时使用。 验证者使用客户机和服务器共享的会话密钥进行加密。 通常，客户机会创建验证者，并将其与服务器或服务的票证一同发送，以便向服务器或服务进行验证。





## 流程

kdc 拥有所有的用户和服务的密码

第一阶段

kinit 向kdc 提供用户名，kdc查找用户，返回用用户密码加密的TGT（包含一个临时key及有效期），用户本地使用密码解密，如果成功，则用户得到TGT

第二阶段

用户用TGT中的临时key加密主机信息请求服务名等校验信息生成校验器，将校验器和TGT发给kdc，kdc解密TGT，用临时key解密校验器，成功后，返回使用请求服务的密码加密的ticket（包含临时key和主机信息）



第三阶段

用户用临时key加密主机信息用户名等校验信息生成校验器，将校验器和ticket一起发给服务。

服务用自己密码打开ticket，获得临时key，用临时key打开校验器，进行验证，成功后返回使用临时key加密的校验器中的时间戳，用户用临时key解密时间戳，与自己发送的一致，则校验通过